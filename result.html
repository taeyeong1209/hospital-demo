<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHA Laboratory - ê²°ê³¼ ì¡°íšŒ</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --sidebar-bg: #002a5c;
            --sidebar-text: #e2e8f0;
            --primary: #f37321;
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --text-dark: #333333;
            --success: #28a745;
            --warning: #ffc107;
        }
        * { box-sizing: border-box; }
        body { margin: 0; font-family: 'Noto Sans KR', sans-serif; background-color: var(--bg-color); color: var(--text-dark); display: flex; height: 100vh; overflow: hidden; }

        /* ì‚¬ì´ë“œë°” */
        .sidebar { width: 260px; background-color: var(--sidebar-bg); padding: 2rem 1.5rem; display: flex; flex-direction: column; color: white; }
        .logo { font-size: 1.5rem; font-weight: 700; margin-bottom: 3rem; color: white; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 20px;}
        .menu-item { display: block; padding: 12px 16px; margin-bottom: 8px; color: var(--sidebar-text); text-decoration: none; border-radius: 8px; transition: 0.3s; font-weight: 500; }
        .menu-item:hover { background-color: rgba(255,255,255,0.1); color: white; }
        .menu-item.active { background-color: var(--primary); color: white; box-shadow: 0 4px 6px rgba(243, 115, 33, 0.3); }

        /* ë©”ì¸ ì½˜í…ì¸  */
        .main-content { flex: 1; padding: 2rem 3rem; overflow-y: auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        .header h2 { font-size: 1.8rem; margin: 0; color: #002a5c; }
        
        /* ë²„íŠ¼ ê·¸ë£¹ */
        .btn-group { display: flex; gap: 10px; }
        .btn-csv { background-color: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-reset { background-color: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: bold; }

        /* ìš”ì•½ ì¹´ë“œ */
        .summary-cards { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 2rem; }
        .summary-card { background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-left: 5px solid var(--primary); }
        .summary-card h3 { margin: 0; color: #666; font-size: 0.9rem; }
        .summary-card p { margin: 10px 0 0 0; font-size: 2rem; font-weight: 700; color: #002a5c; }

        /* í…Œì´ë¸” */
        .table-container { background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); overflow: hidden; }
        table { width: 100%; border-collapse: collapse; }
        th { background-color: #f1f3f5; padding: 1rem; font-weight: 700; color: #495057; text-align: left; border-bottom: 2px solid #dee2e6; }
        td { padding: 1.2rem 1rem; border-bottom: 1px solid #e9ecef; color: #333; }
        tr:hover { background-color: #f8f9fa; }

        .badge { padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; }
        .badge.processing { background-color: #fff3cd; color: #856404; }
        .badge.completed { background-color: #d4edda; color: #155724; }

        .target-tag { display: inline-block; background: #e7f5ff; color: #002a5c; padding: 2px 6px; border-radius: 4px; font-size: 0.85rem; margin-right: 4px; border: 1px solid #d0ebff; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="logo">ğŸ§¬ CHABiotech Genomics Lab System</div>
        <nav>
            <a href="request.html" class="menu-item">ğŸ“ ê²€ì‚¬ ì˜ë¢° (Request)</a>
            <a href="result.html" class="menu-item active">ğŸ“Š ê²°ê³¼ ì¡°íšŒ (Status)</a>
        </nav>
    </div>

    <div class="main-content">
        <div class="header">
            <h2>ê²€ì‚¬ ì§„í–‰ í˜„í™©</h2>
            <div class="btn-group">
                <button onclick="downloadCSV()" class="btn-csv">ğŸ“¥ CSV ë‹¤ìš´ë¡œë“œ</button>
                <button onclick="resetData()" class="btn-reset">ğŸ—‘ï¸ ì´ˆê¸°í™”</button>
            </div>
        </div>

        <div class="summary-cards">
            <div class="summary-card" style="border-left-color: #002a5c;">
                <h3>ì „ì²´ ì˜ë¢° (Total)</h3>
                <p id="totalCount">0</p>
            </div>
            <div class="summary-card" style="border-left-color: var(--warning);">
                <h3>ì§„í–‰ ì¤‘ (Processing)</h3>
                <p id="ingCount">0</p>
            </div>
            <div class="summary-card" style="border-left-color: var(--success);">
                <h3>ì™„ë£Œ (Completed)</h3>
                <p id="doneCount">0</p>
            </div>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>ì ‘ìˆ˜ì¼ì</th>
                        <th>í™˜ì ID</th>
                        <th>í™˜ì ì„±ëª…</th>
                        <th>ê²€ì‚¬ í•­ëª© ë° íƒ€ê²Ÿ</th>
                        <th>ìƒíƒœ</th>
                        <th>ê²°ê³¼ì§€</th>
                    </tr>
                </thead>
                <tbody id="resultTableBody">
                    </tbody>
            </table>
        </div>
    </div>

    <script>
        function loadData() {
            let db = JSON.parse(localStorage.getItem('hospitalDB')) || [];
            
            if (db.length === 0) {
                db = [
                    { date: '2026-02-10', id: 'P-2026-001', name: 'ê¹€ì² ìˆ˜', test: 'NIPT', status: 'Completed' },
                    { date: '2026-02-11', id: 'P-2026-002', name: 'ì´ì˜í¬', test: 'Mom-Free [SMA, Fragile X]', status: 'Processing' }
                ];
                localStorage.setItem('hospitalDB', JSON.stringify(db));
            }

            const tableBody = document.getElementById('resultTableBody');
            tableBody.innerHTML = "";
            let total = 0, ing = 0, done = 0;

            db.reverse().forEach((item) => {
                total++;
                let badgeClass = 'processing';
                let statusText = 'ë¶„ì„ ì§„í–‰ ì¤‘';
                let btnHtml = '<button style="opacity:0.5; border:1px solid #ddd; background:white; padding:4px 8px; border-radius:4px;" disabled>ëŒ€ê¸°</button>';

                if (item.status === 'Completed') {
                    badgeClass = 'completed';
                    statusText = 'ë¶„ì„ ì™„ë£Œ';
                    btnHtml = '<button onclick="alert(\'PDF ê²°ê³¼ì§€ë¥¼ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤.\')" style="color:#002a5c; border:1px solid #002a5c; background:white; padding:4px 8px; border-radius:4px; cursor:pointer; font-weight:bold;">ê²°ê³¼ ë³´ê¸°</button>';
                    done++;
                } else {
                    ing++;
                }

                let displayTest = item.test;
                if(item.test.includes('[')) {
                    const parts = item.test.split('[');
                    const mainTitle = parts[0];
                    const tags = parts[1].replace(']', '').split(',');
                    
                    let tagHtml = '';
                    tags.forEach(tag => {
                        tagHtml += `<span class="target-tag">${tag.trim()}</span>`;
                    });
                    displayTest = `<strong>${mainTitle}</strong><br><div style="margin-top:4px;">${tagHtml}</div>`;
                }

                const row = `
                    <tr>
                        <td>${item.date}</td>
                        <td>${item.id}</td>
                        <td>${item.name}</td>
                        <td>${displayTest}</td>
                        <td><span class="badge ${badgeClass}">${statusText}</span></td>
                        <td>${btnHtml}</td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });

            document.getElementById('totalCount').innerText = total;
            document.getElementById('ingCount').innerText = ing;
            document.getElementById('doneCount').innerText = done;
        }

        // CSV ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜ (BOM ì¶”ê°€ë¡œ í•œê¸€ ê¹¨ì§ í•´ê²°)
        function downloadCSV() {
            let db = JSON.parse(localStorage.getItem('hospitalDB')) || [];
            if(db.length === 0) { alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }

            // CSV í—¤ë” ì‘ì„±
            let csvContent = "Date,Patient ID,Name,Test Item,Status\n";

            db.forEach(row => {
                // ì½¤ë§ˆ(,)ê°€ í¬í•¨ëœ í…ìŠ¤íŠ¸ê°€ ê¹¨ì§€ì§€ ì•Šë„ë¡ ìŒë”°ì˜´í‘œë¡œ ê°ì‹¸ê¸°
                let testItem = `"${row.test}"`; 
                let rowString = `${row.date},${row.id},${row.name},${testItem},${row.status}`;
                csvContent += rowString + "\n";
            });

            // â˜… í•µì‹¬ í•´ê²°ì±…: BOM(Byte Order Mark) ì¶”ê°€ (\uFEFF)
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });

            // ë‹¤ìš´ë¡œë“œ ë§í¬ ìƒì„± ë° í´ë¦­ íŠ¸ë¦¬ê±°
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", "laboratory_results.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function resetData() {
            if(confirm("ì •ë§ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                localStorage.removeItem('hospitalDB');
                location.reload();
            }
        }

        window.onload = loadData;
    </script>
</body>
</html>